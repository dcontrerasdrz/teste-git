from crypt import methods
from email.policy import default
from flask import render_template,url_for,request,redirect,flash
from flask_login import login_user,logout_user

import os

from app import app,db,lm

from app.models.tables import Pereciveis, Usuario
from app.models.forms import Loginform

@lm.user_loader
def load_user(id):
    return Usuario.query.filter_by(id=id).first()


##########################################################################################################################################
##########################################################################################################################################
##########################################################################################################################################
############################################################## I N D E X #################################################################
##########################################################################################################################################
##########################################################################################################################################
##########################################################################################################################################


@app.route('/index')
@app.route('/')
def index():
    return render_template('index.html')


##########################################################################################################################################
##########################################################################################################################################
##########################################################################################################################################
############################################################## L O G I N #################################################################
##########################################################################################################################################
##########################################################################################################################################
##########################################################################################################################################


@app.route('/login', methods=['GET','POST'])
def login():
    form = Loginform()
    if form.validate_on_submit():
        usua = Usuario.query.filter_by(usuario=form.username.data).first()
        if usua and usua.senha == form.password.data:
            login_user(usua)
            flash("logged in.")
            print('certo')
            return redirect(url_for('pereciveis'))
        else:
            flash("invalid login.")
            
    return render_template('login.html', form=form)
 
@app.route("/logout")
def logout():
    logout_user()
    flash("logged out.")
    return redirect(url_for('index'))


##########################################################################################################################################
##########################################################################################################################################
##########################################################################################################################################
######################################################### A D D  U S E R #################################################################
##########################################################################################################################################
##########################################################################################################################################
##########################################################################################################################################


@app.route('/add', methods=['GET','POST'])
def add():
    if request.method =='POST':
        usua=Usuario(request.form['usuario'],request.form['nome'],request.form['email'],request.form['senha'],request.form['condicao'])
        db.session.add(usua)
        db.session.commit() 
        return redirect(url_for('index'))
    return render_template('add.html')


##########################################################################################################################################
##########################################################################################################################################
##########################################################################################################################################
###################################################### P E R E C I V E I S ###############################################################
##########################################################################################################################################
##########################################################################################################################################
##########################################################################################################################################


    
@app.route('/pereciveis')
def pereciveis():
    pereciveis = Pereciveis.query.all()
    return render_template('pereciveis.html', pereciveis=pereciveis)

@app.route('/add_pereciveis', methods=['GET','POST'])
def add_pereciveis():
    if request.method=='POST':
        pereci = Pereciveis(request.form['Aprovacao', request.form['Observacao']])
        db.session.add(pereci)
        db.session.commit()
        redirect(url_for('pereciveis'))
    return render_template('add_pereciveis.html')


@app.route('/edit_pereciveis/<int:id>',methods=['GET','POST'])
def edit_pereciveis(id):
    pereci = Pereciveis.query.get(id)
    if request.method == "POST":
        pereci.Aprovacao = request.form['Aprovacao']
        pereci.Observacao = request.form['Observacao']
        db.session.commit()        
        return redirect(url_for('pereciveis'))
        print('certo')
    else:
        print('errado')
        #redirect(url_for('edit_pereciveis'))
        return render_template('edit_pereciveis.html',pereci=pereci)
        
    


##########################################################################################################################################
##########################################################################################################################################
###################################################### P E R E C I V E I S ###############################################################
##########################################################################################################################################
##########################################################################################################################################
##########################################################################################################################################



@app.route('/dashboard')
def dashboard():
    return render_template('dashboard.html')